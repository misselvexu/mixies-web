@extends(view.wondergem.template.html, title: "Scripting")
@section(head) {
<script src="/assets/wondergem/ace/ace.js" type="text/javascript"></script>

<style>
    #editor {
        height:300px;
    }

    #output .TRACE {
        color: #555555;
    }

    #output .SUCCESS {
        color: #21692e
    }

    #output .ERROR {
        color: #690000;
    }

    #output .WARN {
        color: #bda721;
    }
</style>
}

@section(breadcrumbs) {
<li><a href="/system/state">System State</a></li>
}

@pageHeader() {
    Hello
}

<div id="editor">Hello Kitty</div>
<div class="form-actions">
    <a href="#" id="execute" class="btn btn-success btn-lg">Run</a>
</div>
<div class="section"><span class="h2">Output</span> <span class="label label-primary">Primary</span></div>
<table class="table table-striped" id="outputTable">
    <tr>
        <th class="col-md-3">Timestamp</th>
        <th class="col-md-9">Message</th>
    </tr>
    <tbody id="output">

    </tbody>
</table>
<script type="text/javascript">

    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/idle_fingers");
    editor.getSession().setMode("ace/mode/javascript");
    var taskId = null;
    var lastLog = 0;
    var timer = null;

    function updateState() {
        $.getJSON('@prefix/system/task/'+taskId+'/api/info',
              { logLimit: lastLog },
              function(data) {
                    if (!data.found) {
                        $('#taskId').text('');
                    } else {
                        for(i = 0; i < data.logs.length; i++) {
                            var row = $('#output').append($('<tr></tr>'));
                            row.append($('<td></td>').text(data.logs[i].date));
                            row.append($('<td></td>').text(data.logs[i].message).addClass("message").addClass(data.logs[i].type));
                        }
                        lastLog = data.lastLog;
                        clearTimeout(timer);
                        timer = setTimeout(updateState, 1000);
                    }
              }
        );
    }

    $('#execute').click(function() {
        clearMessages();
        clearTimeout(timer);
        $('#output').html('');

        $.ajax({
            url: '@prefix/system/scripting/api/execute',
            type: 'post',
            data: editor.getSession().getDocument().getValue(),
            contentType: 'text/plain',
            dataType: 'json',
            success: function(data) {
                if (data.error) {
                    addError(data.message);
                } else {
                    $('#outputTable').show();
                    taskId = data.task;
                    lastLog = 0;
                    clearTimeout(timer);
                    timer = setTimeout(updateState, 500);
                }
            }
        })
    });

</script>