@extends(view.wondergem.template.html, title: "Scripting")
@section(head) {
<script src="/assets/wondergem/ace/ace.js" type="text/javascript"></script>

<style>
    #editor {
        height:300px;
    }

    #output .TRACE {
        color: #555555;
    }

    #output .SUCCESS {
        color: #21692e
    }

    #output .ERROR {
        color: #690000;
    }

    #output .WARN {
        color: #bda721;
    }
</style>
}

@section(breadcrumbs) {
    <li><a href="/system/state">System Scripting</a></li>
}

@pageHeader() {
    System Scripting
}

<div id="editor">task.log('Good Morning Dave');</div>
<div class="form-actions">
    <a href="#" id="execute" class="btn btn-success btn-lg">Run</a>
    <a href="#" id="cancel" style="display:none" class="btn btn-danger btn-lg">Cancel</a>
</div>

<div id="outputBlock" style="display: none">
    @heading() {
        Output <span class="label"></span>
        <span class="pull-right small" id="taskId"></span>
    }

    <table class="table table-striped">
        <tr>
            <th class="col-md-3 align-right">Timestamp</th>
            <th class="col-md-9">Message</th>
        </tr>
        <tbody id="output">

        </tbody>
    </table>
</div>

<script type="text/javascript">

    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/idle_fingers");
    editor.getSession().setMode("ace/mode/javascript");
    var taskId = null;
    var lastLog = 0;
    var timer = null;

    function updateState() {
        $.getJSON('@prefix/system/task/'+taskId+'/api/info',
              { logLimit: lastLog },
              function(data) {
                    clearTimeout(timer);
                    if (data.logs != null) {
                        for (i = 0; i < data.logs.length; i++) {
                            var row = $('<tr></tr>');
                            row.append($('<td></td>').text(data.logs[i].date).addClass("align-right"));
                            row.append($('<td></td>').text(data.logs[i].message).addClass("message").addClass(data.logs[i].type));
                            row.appendTo($('#output'));
                        }
                        lastLog = data.lastLog;
                    }
                    if (data.found && data.state != 'TERMINATED') {
                        if (data.state == 'RUNNING') {
                            $('#outputBlock .label').removeClass().addClass('label').addClass('label-success').text(data.state);
                        } else if (data.state == 'SCHEDULED') {
                            $('#outputBlock .label').removeClass().addClass('label').addClass('label-info').text(data.state);
                        } else {
                            $('#outputBlock .label').removeClass().addClass('label').addClass('label-warning').text(data.state);
                        }
                        timer = setTimeout(updateState, 1000);
                    } else {
                        $('#outputBlock .label').removeClass().addClass('label').addClass('label-default').text(data.state != null ? data.state : '');
                        taskId = null;
                        $('#cancel').hide();
                        $('#execute').removeClass('disabled');
                    }
              }
        );
    }

    $('#execute').click(function() {
        if ($('#execute').hasClass('disabled')) {
            return;
        }

        clearMessages();
        clearTimeout(timer);
        $('#output').html('');

        $.ajax({
            url: '@prefix/system/scripting/api/execute',
            type: 'post',
            data: editor.getSession().getDocument().getValue(),
            contentType: 'text/plain',
            dataType: 'json',
            success: function(data) {
                if (data.error) {
                    addError(data.message);
                } else {
                    taskId = data.task;
                    lastLog = 0;

                    $('#outputBlock').show();
                    $('#cancel').show();
                    $('#execute').addClass('disabled');

                    clearTimeout(timer);
                    timer = setTimeout(updateState, 500);
                }
            }
        })
    });

    $('#cancel').click(function() {
        if (taskId != null) {
            $.getJSON('@prefix/system/task/'+taskId+'/api/cancel',
                    { },
                    function(data) {
                        clearTimeout(timer);
                        timer = setTimeout(updateState, 500);
                    }
            );
        }
    });

</script>